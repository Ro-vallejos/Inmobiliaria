@model _net_integrador.Models.Contrato

@{
    ViewData["Title"] = "Nuevo Contrato";
}

<div class="container mt-4">
    <h2>Nuevo Contrato</h2>

    <form asp-action="Agregar" method="post" class="mt-4">

        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <div class="form-group mb-3">
            <label asp-for="id_inquilino" class="control-label">Seleccione el inquilino</label>
            <select asp-for="id_inquilino" asp-items="@ViewBag.Inquilinos" class="form-control">
                <option value="">-- Seleccione un inquilino --</option>
            </select>
            <span asp-validation-for="id_inquilino" class="text-danger"></span>
        </div>
        <div class="form-group mb-3">
            @Html.LabelFor(m => m.fecha_inicio, "Ingrese la fecha de inicio del contrato")
            @Html.TextBoxFor(m => m.fecha_inicio, new {
            @class = "form-control",
                        type = "date",
                        min = DateTime.Now.ToString("yyyy-MM-dd"),
                        id = "fechaInicio"
                        })
            @Html.ValidationMessageFor(m => m.fecha_inicio, "", new { @class = "text-danger" })
        </div>

        <div class="form-group mb-3">
            @Html.LabelFor(m => m.DuracionEnMeses, "Ingrese la cantidad de meses de duración del contrato", new { @class
                        = "control-label" })
            @Html.TextBoxFor(m => m.DuracionEnMeses, new
                        {
                @class = "form-control",
                        type = "number",
                        min = "1",
                        id = "duracionMeses"
                        })
            @Html.ValidationMessageFor(m => m.DuracionEnMeses, "", new { @class = "text-danger" })
            @Html.HiddenFor(m => m.fecha_fin)
        </div>

        <div class="form-group mb-3">
            <label class="control-label">Fecha Final Calculada</label>
            <input type="text" id="fechaFinDisplay" class="form-control" readonly value="Pendiente..." />
        </div>


        <button type="submit" name="actionType" value="BuscarInmuebles" class="btn btn-info mt-2">
            Buscar inmuebles disponibles
        </button>

        <hr />
        @if (ViewBag.InmueblesDisponibles != null &&
                ((List<_net_integrador.Models.Inmueble>)ViewBag.InmueblesDisponibles).Any())
        {
            var inmuebles = (List<_net_integrador.Models.Inmueble>)ViewBag.InmueblesDisponibles;
            <hr />
            <h4>Seleccione Inmueble</h4>
            <div class="form-group">
                <select asp-for="id_inmueble" class="form-control" id="selectInmueble">
                    <option value="">-- Seleccione Inmueble --</option>
                    @foreach (var inmueble in inmuebles)
                    {
                        <option value="@inmueble.id" data-precio="@inmueble.precio">Dirección: @inmueble.direccion - Cantidad ambientes: @inmueble.ambientes</option>
                    }
                </select>
                <span asp-validation-for="id_inmueble" class="text-danger"></span>
            </div>

            <div class="form-group mt-2">
                <label for="monto_mensual">Monto Mensual</label>
                <input asp-for="monto_mensual" id="montoMensual" class="form-control" readonly/>
                <span asp-validation-for="monto_mensual" class="text-danger"></span>
            </div>

            <button type="submit" name="actionType" value="CrearContrato" class="btn btn-success mt-2">Crear
                Contrato</button>
        }
        else if (ViewBag.InmueblesDisponibles != null)
        {
            <div class="alert alert-warning mt-2">No hay inmuebles disponibles para las fechas seleccionadas.</div>
        }
    </form>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var $fechaInicio = $('#fechaInicio');
            var $duracionMeses = $('#duracionMeses');
            var $fechaFinHidden = $('#fecha_fin');
            var $fechaFinDisplay = $('#fechaFinDisplay');
            var $selectInmueble = $('#selectInmueble');
            var $montoMensual = $('#montoMensual');
            function calcularFechaFin() {
                var inicioStr = $fechaInicio.val();

                var mesesStr = $duracionMeses.val();
                var meses = parseInt(mesesStr);


                if (inicioStr.length === 0 || isNaN(meses) || meses <= 0) {
                    $fechaFinDisplay.val("Ingrese fecha de inicio");
                    $fechaFinHidden.val('');
                    return;
                }

                var fecha = new Date(inicioStr + 'T00:00:00');

                if (isNaN(fecha.getTime())) {
                    $fechaFinDisplay.val("Fecha de inicio inválida.");
                    $fechaFinHidden.val('');
                    return;
                }
                fecha.setMonth(fecha.getMonth() + meses);
                var dia = String(fecha.getDate()).padStart(2, '0');
                var mes = String(fecha.getMonth() + 1).padStart(2, '0');
                var anio = fecha.getFullYear();

                var fechaFinalDisplay = `${dia}/${mes}/${anio}`;
                var fechaFinalHidden = `${anio}-${mes}-${dia}`;
                $fechaFinDisplay.val(fechaFinalDisplay);
                $fechaFinHidden.val(fechaFinalHidden);
            }
             function actualizarMontoMensual() {
                var $selectedOption = $selectInmueble.find('option:selected');
                
                var precio = $selectedOption.data('precio');

                if (precio > 0) {
                    $montoMensual.val(precio);
                } else {
                    $montoMensual.val('');
                }
            }
            $selectInmueble.on('change', actualizarMontoMensual);
            $fechaInicio.on('change', calcularFechaFin);
            $duracionMeses.on('input', calcularFechaFin);
            calcularFechaFin();
        });
    </script>
}